### 进展

目前我只完成了开普勒-自动化-邮件项目，达成了执行集 100% 的成功率

正在做 WOA 中台的 API 测试，正在熟悉相关文档，还未开始

后续打算继续做 OA 中台的 API 测试

### 开普勒-自动化-邮件项目介绍

现在，开普勒的邮件自动化有用的一共三部分：

- API 文档
- API 测试
- 场景测试

但是，并不是全部内容都有用，只用 webmail 那一栏的内容才需要自动化，以图片实例：

【图片】API 文档

<img src=".\assets\J1.png" alt="image-20220915154015515" style="zoom:50%;" />

【图片】API 测试

<img src=".\assets\J2.png" alt="image-20220915154131422" style="zoom:50%;" />

【图片】场景用例

<img src=".\assets\J3.png" alt="image-20220915154900965" style="zoom:50%;" />

### 运行环境

- **webmail beta 环境**

IP： 120.92.124.158

- **webmail 预发布环境**

IP： 10.19.210.223

邮件自动化测试，**只需要测试上面两个环境**，而且每次填写的**用例接口传入的请求头都是固定的**，传入下面这个 webmail-李蓝骏，点击全部替换，以图片实例：

![image-20220915161201893](.\assets\J4.png)

![image-20220915161300581](.\assets\J5.png)

### 我之前的流程

这里需要说明一下，我主要的工作是负责填写**场景用例**。一般的步骤是根据 **API 文档**来填写 **API 测试**，再根据 **API 测试**来填写到**场景用例**中，但我早期并不知道这样的流程，于是我之前的流程是：

1. 先根据每个**用例分组**，写出需要的**场景用例**（比如在邮件标签**用例分组**，有搜索标签-关键字中文、搜索标签-关键字英文、 修改标签-标签顺序-上移中等不同的**场景用例**）
2. 再根据每个**场景用例**，写出需要的**用例步骤**（比如在搜索标签-关键字中文**场景用例**，**用例步骤**为：创建标签中文英文数字组合（获取标签 id）--搜索标签（中文）--删除标签 这三个**用例接口**）
3. 最后我在 PC 端的邮件页面（https://email.wps.cn/），一个个手动测试**用例接口**，如果**用例接口**没问题，再填入**场景用例**中，最后在两个环境中分别跑一下，如果没问题，即**完成一个场景用例**

### 需要维护的表

但是，这样做是非常麻烦的！！！

于是我开发了哥白尼，极大的简化了上述流程，哥白尼所维护的表有两个文件，如下：

![image-20220915161454523](.\assets\J6.png)

分别对应了**场景用例**和**用例步骤**，详细文件夹如下：

![image-20220915161540828](.\assets\J7.png)

![image-20220915161941790](.\assets\J8.png)

**场景用例文件夹**中包含了全部的**用例分组**，开普勒中一共 9 个**用例分组**，因此该文件夹中也有 9 个**用例分组**

下面以**场景用例文件夹**中的**邮件标签（其中一个用例分组）**为例展示：

![image-20220915162207037](.\assets\J9.png)

![image-20220915162632529](.\assets\J10.png)

可以发现，四个 # 号对应的就是**场景用例**的名字，下面一行的就是该用例的全部**用例步骤**

```txt
#### 添加标签-已发送邮件
创建标签（获取标签 id）-发送一封邮件至收件箱-刷新收件箱-清空已发送-延迟十秒-获取收件箱列表（确保共一封邮件，获取第一封邮件 id）-收件箱邮件移动到已发送（移动第一封邮件）-获取已发送邮件列表（确保共一封邮件，获取第一封邮件 id）-延迟十秒-已发送邮件添加标签-获取已发送邮件列表（确保第一封邮件已添加标签）-删除标签-清空收件箱-清空已发送-清空草稿箱
```

每个**用例步骤**相连的符号是 - 号，举个例子，`A-B-C` 就代表先进行步骤 A，再进行步骤 B，最后进行步骤 C

这就好办了，这张表就代表邮件标签（这个**用例分组**）下的全部**场景用例**，也就是只需要维护这张表即可

而每个**用例步骤**对应的参数，则储存在**用例步骤文件夹**中

下面以**用例步骤文件夹**中的**邮件标签（其中一个用例分组）**为例展示：

![image-20220915162141812](.\assets\J11.png)

同样的，四个 # 号对应的就是**用例步骤**的名字，下面几行的就是该**用例步骤**的全部参数

```txt
#### 创建标签（获取标签 id）
desc, method, uri = ['创建标签（获取标签 id）', 'post', '/api/v1/mail/tag']
body = "{\n\t\"name\": \"标签_${random_int(3)}\",\n\t\"color\": \"#F52F59\",\n\t\"mail_id\": \"${mail_id}\"\n}"
extracts_dict = {"tag_id": "$.data.tag_id"}
```

看起来复杂，实际上很简单，首先第一行对应的就是 `步骤名称 + 请求方法 + 接口`

```txt
desc, method, uri = ['xxx', 'xxx', 'xxx']
```

从第二行开始，就可以选择是否添加不同的参数，详细如下：

```txt
body = "xxx"
params_dict = {"xxx": "xxx"}
extracts_dict = {"xxx": "xxx"}
validations_dict = {"xxx": "xxx"}
```

`body` 对应了**请求体**，`params_dict` 对应了**Query**，`extracts_dict` 对应了**参数提取**，`validations_dict` 对应了**校验方式**

![image-20220915172029225](.\assets\J12.png)

由上可知，只需要维护**场景用例文件夹**和**用例步骤文件夹**即可

最后使用 cmd 一键运行哥白尼，即可更新开普勒的**全部用例分组**中的**全部用例步骤**

```txt
python 表单迭代.py
```

### 部分失败的原因

开普勒的执行集中，运行的是全部场景测试（目前共 119 个场景用例），所需要自动化的执行集有两个，如下：

![image-20220915173825337](.\assets\J13.png)

**经历了多次执行失败后，我终于将两个执行集调节至 100% 的成功率，总结出的经验如下：**

1. **添加延迟**

下面以【写邮件-聚合邮件查询-星标-标记未读-彻底删除】这个场景用例为例：

<img src=".\assets\J14.png" alt="image-20220915174533010"  />

它完整的**用例步骤**如下：

```
#### 写邮件-聚合邮件查询-星标-标记未读-彻底删除

切换至聚合模式-发送一封邮件至收件箱-刷新收件箱-延迟十秒-获取收件箱列表（确保共一封邮件，获取第一封邮件 id）-延迟十秒-获取收件箱列表（确保共一封邮件，获取第一封邮件 agg_id）-收件箱标记星标（聚合模式）-收件箱标记未读（聚合模式）-获取收件箱列表（确保第一封邮件已标记星标）-获取收件箱列表（确保第一封邮件已标记未读）-清空收件箱-清空已发送-清空草稿箱
```

我在每个 `获取收件箱列表（确保xx，获取xx id / agg_id）` 步骤前面都加上了 `延迟十秒` 的步骤，这是因为邮箱接收邮件有延迟，为了确保获得邮件的 id / agg_id 后才进行后面的步骤

2. **每个场景用例的最后都要清空**

依然以上面**用例步骤**的举例

```txt
#### 写邮件-聚合邮件查询-星标-标记未读-彻底删除

切换至聚合模式-发送一封邮件至收件箱-刷新收件箱-延迟十秒-获取收件箱列表（确保共一封邮件，获取第一封邮件 id）-延迟十秒-获取收件箱列表（确保共一封邮件，获取第一封邮件 agg_id）-收件箱标记星标（聚合模式）-收件箱标记未读（聚合模式）-获取收件箱列表（确保第一封邮件已标记星标）-获取收件箱列表（确保第一封邮件已标记未读）-清空收件箱-清空已发送-清空草稿箱
```

我在最后的步骤都添加了 `清空收件箱-清空已发送-清空草稿箱`，这是因为我的邮箱有时会收到别人发的邮件，导致与某些**用例步骤**冲突（比如 `获取收件箱列表（确保共一封邮件，获取第一封邮件 id）`），因此每次都要清空邮箱，确保不会产生冲突

3. **特殊情况特殊放**

哥白尼不是万能的，比如下面的【创建标签-异常-标签数量超过60】这种场景用例

![image-20220916103630212](.\assets\J15.png)

它使用了循环次数这个功能步骤，而哥白尼还没有该功能步骤的（目前只支持延迟步骤），因此我将它单独放在 webmail 中，示例图片如下：

<img src=".\assets\J16.png" alt="image-20220916104043808" style="zoom:50%;" />

这个分组中，除了有哥白尼无法处理的**场景用例**，还存放不能每次运行 100% 成功的**场景用例**，比如 `自定义文件夹-批量移动到已删除` 这个**场景用例** 可以在 beta 环境跑成功，但是不能在预发布环境跑成功，那么预发布的执行集就可以在这个分组中剔除某些**场景用例**（因为其他分组在两个执行集中都能运行，因此其他分组都不用剔除）

PS：目前预发布环境不能正常跑的场景用例如下：

```txt
已删除邮件查看
垃圾邮件邮件查看
草稿箱邮件查看
已删除-批量标记未读
已删除-批量标记星标
已发送-批量标记未读
垃圾邮件-批量移动到已删除
已发送-批量移动到已删除
草稿箱-批量移动到已删除
收件箱-非聚合模式-批量移动到垃圾邮件
收件箱-聚合模式-批量移动到垃圾邮件
收件箱-聚合模式-批量移动到已删除
文件夹操作-创建自定义文件夹
自定义文件夹-批量移动到已删除
自定义文件夹-批量标记未读
```